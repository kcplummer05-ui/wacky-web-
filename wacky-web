import React, { useState, useEffect } from 'react';
import { 
  Shield, 
  Wifi, 
  Zap, 
  History, 
  Search, 
  AlertCircle,
  RefreshCw,
  CheckCircle2,
  Activity,
  Globe,
  Database,
  Link,
  Info,
  ShieldAlert,
  Trash2,
  Terminal,
  Stars,
  Ghost,
  Lightbulb,
  Sparkles,
  ChevronRight
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from 'firebase/firestore';

// --- CONFIGURATION & GLOBALS ---
const apiKey = ""; // The execution environment provides the key at runtime
const firebaseConfig = JSON.parse(__firebase_config);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'mr-heppard-wacky-web';

// Initialize Firebase services
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('security');
  const [targetUrl, setTargetUrl] = useState('');
  const [isScanning, setIsScanning] = useState(false);
  const [scanResult, setScanResult] = useState(null);
  const [scanHistory, setScanHistory] = useState([]);
  const [error, setError] = useState(null);
  
  // Wacky Tip State
  const [wackyTip, setWackyTip] = useState('');
  const [loadingTip, setLoadingTip] = useState(false);

  // --- MANDATORY RULE 3: AUTHENTICATION ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        // In this environment, we sign in anonymously as the primary method
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Authentication sequence failure:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // --- MANDATORY RULE 1 & 2: FIRESTORE DATA ---
  useEffect(() => {
    if (!user) return;

    // Use strictly formatted path for user-specific data
    const scansCollection = collection(db, 'artifacts', appId, 'users', user.uid, 'scans');
    
    // Set up real-time listener
    const unsubscribe = onSnapshot(scansCollection, (snapshot) => {
      const docs = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      // RULE 2: Sort in memory rather than using orderBy in query
      setScanHistory(docs.sort((a, b) => b.timestamp - a.timestamp));
    }, (err) => {
      console.error("Firestore sync error:", err);
    });

    return () => unsubscribe();
  }, [user]);

  // --- INITIALIZE WACKY TIP ---
  useEffect(() => {
    fetchWackyTip();
  }, []);

  const fetchWackyTip = async () => {
    setLoadingTip(true);
    const systemPrompt = `You are Mr. Heppard's Digital Historian. Generate one short, weird, or wacky fact about the history of the internet or web technology. 
    Keep it under 25 words. Be wacky and mysterious but stay factual. Do not use quotes.`;

    const fetchWithRetry = async (retries = 5, delay = 1000) => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "Gimme a wacky web fact." }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          })
        });
        if (!response.ok) throw new Error(`API Status: ${response.status}`);
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (err) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, delay));
          return fetchWithRetry(retries - 1, delay * 2);
        }
        throw err;
      }
    };

    try {
      const fact = await fetchWithRetry();
      setWackyTip(fact || "The first webcam was invented to check if a coffee pot was full.");
    } catch (err) {
      setWackyTip("Error reaching the wacky archives. The web is currently shy.");
    } finally {
      setLoadingTip(false);
    }
  };

  // --- AI SECURITY SCANNER ---
  const analyzeUrlSafety = async (url) => {
    if (!url || !user) return;
    setIsScanning(true);
    setScanResult(null);
    setError(null);

    const systemPrompt = `You are Mr. Heppard's Wacky Web Analyst. Analyze URLs for security risks like phishing or scams. 
    Return JSON format: {"status": "safe"|"suspicious"|"malicious", "reason": "1-sentence wacky explanation"}`;

    const fetchWithRetry = async (retries = 5, delay = 1000) => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Analyze link: ${url}` }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
          })
        });
        if (!response.ok) throw new Error(`API Status: ${response.status}`);
        const data = await response.json();
        return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
      } catch (err) {
        if (retries > 0) {
          await new Promise(r => setTimeout(r, delay));
          return fetchWithRetry(retries - 1, delay * 2);
        }
        throw err;
      }
    };

    try {
      const result = await fetchWithRetry();
      setScanResult(result);
      
      // Save results to user's private collection
      await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'scans'), {
        url: url,
        status: result.status,
        reason: result.reason,
        timestamp: Date.now()
      });
    } catch (err) {
      setError("The wacky scanner hit a digital bump. Try re-inserting the link.");
    } finally {
      setIsScanning(false);
    }
  };

  const deleteHistoryItem = async (id) => {
    if (!user) return;
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'scans', id));
    } catch (err) {
      console.error("Deletion failed:", err);
    }
  };

  const getStatusStyle = (status) => {
    if (status === 'safe') return 'border-cyan-500/50 bg-cyan-500/10 text-cyan-400';
    if (status === 'suspicious') return 'border-purple-500/50 bg-purple-500/10 text-purple-400';
    if (status === 'malicious') return 'border-rose-500/50 bg-rose-500/10 text-rose-400';
    return 'border-slate-800 bg-slate-900/50 text-slate-500';
  };

  return (
    <div className="min-h-screen bg-[#06070a] text-slate-300 font-mono pb-32 selection:bg-cyan-500/30">
      
      {/* HEADER SECTION */}
      <header className="px-6 pt-10 pb-6 border-b border-purple-900/20 bg-[#06070a]/90 backdrop-blur-xl sticky top-0 z-50 shadow-2xl">
        <div className="flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="p-2.5 bg-purple-500/10 border border-purple-500/30 rounded-xl shadow-[0_0_20px_rgba(168,85,247,0.2)]">
              <Ghost size={24} className="text-purple-400" />
            </div>
            <div>
              <h1 className="text-[10px] font-black tracking-[0.3em] text-white/50 uppercase leading-none mb-1">Mr. Heppard's</h1>
              <h2 className="text-sm font-black tracking-tight text-cyan-400 uppercase italic leading-none">Wacky Web Terminal</h2>
              <div className="flex items-center gap-2 mt-1.5">
                <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_#10b981]"></span>
                <span className="text-[9px] font-bold text-emerald-500/80 uppercase tracking-widest">Digital Realm Online</span>
              </div>
            </div>
          </div>
          <div className="text-right">
            <p className="text-[8px] text-slate-600 font-black uppercase tracking-widest mb-0.5">Core_ID</p>
            <p className="text-[9px] text-slate-500 font-bold truncate max-w-[70px]">{user?.uid || 'BOOTING...'}</p>
          </div>
        </div>
      </header>

      <main className="p-5 max-w-lg mx-auto space-y-6">
        
        {/* WACKY WONDER CARD */}
        <section className="bg-gradient-to-br from-indigo-950/30 to-purple-950/20 border border-purple-500/20 p-5 rounded-2xl relative group overflow-hidden shadow-inner">
          <div className="flex items-center gap-2 mb-2.5">
            <Sparkles size={14} className="text-yellow-400 animate-pulse" />
            <span className="text-[9px] font-black uppercase text-purple-300 tracking-[0.25em]">Wonder_of_the_Day</span>
          </div>
          {loadingTip ? (
            <div className="flex items-center gap-2 py-1">
              <RefreshCw size={12} className="animate-spin text-slate-600" />
              <span className="text-[10px] text-slate-600 italic">Accessing wacky mainframe...</span>
            </div>
          ) : (
            <p className="text-xs leading-relaxed text-slate-400 font-medium italic pr-8">
              "{wackyTip}"
            </p>
          )}
          <div className="absolute -right-4 -bottom-4 opacity-5 pointer-events-none group-hover:opacity-10 transition-opacity duration-700">
            <Lightbulb size={90} />
          </div>
        </section>

        {/* SCANNER CONSOLE */}
        {activeTab === 'security' && (
          <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="bg-slate-900/30 border border-purple-900/30 rounded-2xl p-6 shadow-2xl relative">
              <div className="flex items-center gap-2 mb-4 text-cyan-500/70">
                <Terminal size={14} />
                <span className="text-[9px] font-black uppercase tracking-widest">Input: URL_VECTOR</span>
              </div>
              <input 
                type="text"
                placeholder="INSERT_MYSTERIOUS_LINK..."
                className="w-full bg-black/40 border border-slate-800 rounded-xl py-4 px-5 text-sm font-mono text-cyan-400 outline-none focus:border-cyan-500/50 transition-all placeholder:text-slate-800"
                value={targetUrl}
                onChange={(e) => setTargetUrl(e.target.value)}
              />
              <button 
                onClick={() => analyzeUrlSafety(targetUrl)}
                disabled={isScanning || !targetUrl}
                className="w-full mt-4 bg-gradient-to-r from-purple-700 to-cyan-700 hover:from-purple-600 hover:to-cyan-600 text-white py-4 rounded-xl font-black uppercase tracking-widest flex items-center justify-center gap-3 transition-all active:scale-95 disabled:opacity-20 shadow-[0_10px_30px_rgba(168,85,247,0.25)]"
              >
                {isScanning ? <RefreshCw className="animate-spin" size={18} /> : <ShieldAlert size={18} />}
                {isScanning ? "PROCESSING..." : "ACTIVATE_WACKY_SCAN"}
              </button>
            </div>

            {/* SCAN RESULT DISPLAY */}
            {scanResult && !isScanning && (
              <div className={`p-6 rounded-2xl border ${getStatusStyle(scanResult.status)} animate-in zoom-in-95 shadow-lg relative`}>
                <div className="flex items-center gap-3 mb-3">
                  <Shield size={22} className="animate-bounce" />
                  <h3 className="text-sm font-black uppercase tracking-widest">Wonder_Scan_Complete</h3>
                </div>
                <div className="text-[10px] font-black mb-4 py-1.5 px-3 bg-black/40 rounded-lg uppercase tracking-widest inline-block border border-current/30 shadow-sm">
                  Threat_Level: {scanResult.status}
                </div>
                <p className="text-xs leading-relaxed opacity-90 border-l-2 border-current pl-4 italic bg-current/5 py-2 rounded-r-lg">
                  "{scanResult.reason}"
                </p>
              </div>
            )}

            {/* SYSTEM STATS HUD */}
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-900/30 border border-slate-800 p-5 rounded-2xl group hover:border-cyan-500/40 transition-colors">
                <Activity size={18} className="text-cyan-500 mb-2 group-hover:scale-110 transition-transform" />
                <div className="text-xl font-black text-white">42ms</div>
                <div className="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Wacky_Response</div>
              </div>
              <div className="bg-slate-900/30 border border-slate-800 p-5 rounded-2xl group hover:border-purple-500/40 transition-colors text-right">
                <Zap size={18} className="text-purple-500 mb-2 ml-auto group-hover:rotate-12 transition-transform" />
                <div className="text-xl font-black text-white">99.9%</div>
                <div className="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Craziness_Core</div>
              </div>
            </div>
          </div>
        )}

        {/* LOGS / ARCHIVE VIEW */}
        {activeTab === 'history' && (
          <div className="space-y-4 animate-in fade-in duration-500">
            <div className="flex justify-between items-center mb-6 px-1">
              <h3 className="text-xs font-black text-slate-600 uppercase tracking-[0.4em] flex items-center gap-2">
                <History size={16} /> Wacky_Logs_V02
              </h3>
              <div className="h-0.5 flex-1 mx-4 bg-slate-900/50 rounded-full"></div>
              <span className="text-[10px] font-black text-purple-500/60 uppercase">Count: {scanHistory.length}</span>
            </div>
            
            {scanHistory.length === 0 ? (
              <div className="text-center py-24 border border-dashed border-slate-900 rounded-[2rem] bg-slate-900/10">
                <Ghost className="mx-auto text-slate-800 mb-4 opacity-50" size={40} />
                <p className="text-[10px] text-slate-700 font-black uppercase tracking-[0.2em]">The archive is spectral...</p>
              </div>
            ) : (
              <div className="space-y-3">
                {scanHistory.map(item => (
                  <div key={item.id} className="bg-slate-900/40 border border-slate-800/60 p-4 rounded-2xl flex items-center justify-between group hover:border-purple-500/40 transition-all hover:bg-slate-900/60 shadow-sm">
                    <div className="flex items-center gap-4 truncate">
                      <div className={`w-2.5 h-2.5 rounded-full shadow-[0_0_8px_currentColor] ${item.status === 'safe' ? 'text-emerald-500 bg-emerald-500' : item.status === 'suspicious' ? 'text-purple-500 bg-purple-500' : 'text-rose-500 bg-rose-500'}`}></div>
                      <div className="truncate">
                        <p className="text-xs font-bold text-slate-200 truncate pr-2 tracking-tight">{item.url}</p>
                        <p className="text-[9px] text-slate-600 uppercase tracking-tighter mt-1 font-bold">
                          {new Date(item.timestamp).toLocaleTimeString()} â€¢ STATUS_{item.status}
                        </p>
                      </div>
                    </div>
                    <button 
                      onClick={() => deleteHistoryItem(item.id)}
                      className="p-2 text-slate-800 hover:text-rose-500 transition-colors opacity-0 group-hover:opacity-100"
                    >
                      <Trash2 size={16} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}

      </main>

      {/* NAVIGATION DOCK */}
      <nav className="fixed bottom-8 left-6 right-6 h-20 bg-black/80 backdrop-blur-2xl border border-purple-900/30 rounded-[2.5rem] px-8 flex justify-between items-center z-50 shadow-[0_-15px_40px_rgba(0,0,0,0.8)]">
        <NavButton active={activeTab === 'security'} onClick={() => setActiveTab('security')} icon={<Shield size={22} />} label="Scanner" />
        <NavButton active={activeTab === 'history'} onClick={() => setActiveTab('history')} icon={<History size={22} />} label="Archive" />
        <NavButton active={activeTab === 'network'} onClick={() => setActiveTab('network')} icon={<Globe size={22} />} label="World" />
        <NavButton active={activeTab === 'boost'} onClick={() => setActiveTab('boost')} icon={<Zap size={22} />} label="Turbo" />
      </nav>

      {/* BACKGROUND DECORATIONS */}
      <div className="fixed inset-0 pointer-events-none opacity-[0.06] z-[-1]" style={{backgroundImage: 'radial-gradient(#a855f7 1px, transparent 0)', backgroundSize: '30px 30px'}}></div>
      
      {/* SCANLINE OVERLAY */}
      <div className="fixed inset-0 pointer-events-none z-[100] bg-gradient-to-b from-transparent via-purple-500/[0.03] to-transparent bg-[length:100%_6px] animate-pulse"></div>
    </div>
  );
};

const NavButton = ({ active, onClick, icon, label }) => (
  <button 
    onClick={onClick}
    className={`flex flex-col items-center gap-1.5 transition-all duration-300 ${active ? 'text-cyan-400' : 'text-slate-600'}`}
  >
    <div className={`p-2 rounded-2xl transition-all ${active ? 'bg-cyan-400/10 drop-shadow-[0_0_12px_rgba(34,211,238,0.5)] scale-110' : 'hover:bg-white/5'}`}>
      {icon}
    </div>
    <span className={`text-[8px] font-black uppercase tracking-[0.2em] transition-opacity ${active ? 'opacity-100' : 'opacity-40'}`}>
      {label}
    </span>
    {active && <div className="w-1 h-1 bg-cyan-400 rounded-full shadow-[0_0_8px_#22d3ee] mt-1"></div>}
  </button>
);

export default App;

